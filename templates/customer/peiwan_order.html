{% extends "base.html" %}
{% block content %}
<div class="card">
    <div class="card-header">
        <i class="fas fa-headset"></i> 预约陪玩
    </div>
    <div class="card-body">
        {% if current_customer %}
        <div class="alert alert-info py-2">您已登录，将以此账号（{{ current_customer.phone }}）创建订单。</div>
        {% endif %}
        {% if not games or not price_data %}
        <p class="text-muted">暂无陪玩项目，请先 <a href="{{ url_for('customer_peiwan_index') }}">查看陪玩价格</a> 或使用 <a href="{{ url_for('customer_order') }}">代肝服务</a>。</p>
        {% else %}
        <form method="POST">
            <div class="mb-3">
                <label class="form-label">手机号 *</label>
                <input type="tel" name="phone" class="form-control" value="{{ current_customer.phone if current_customer else '' }}" {{ 'readonly' if current_customer else '' }} required>
            </div>
            <div class="mb-3">
                <label class="form-label">称呼</label>
                <input type="text" name="name" class="form-control" value="{{ current_customer.name if current_customer else '' }}" placeholder="选填">
            </div>
            <div class="mb-3">
                <label class="form-label">游戏 *</label>
                <select name="game" id="game" class="form-select" required>
                    <option value="">请选择</option>
                    {% for g in games %}
                    <option value="{{ g[0] }}">{{ g[0] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">陪玩类型 *</label>
                <select name="task_type" id="task_type" class="form-select" required>
                    <option value="">请先选择游戏</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">单价</label>
                <input type="text" id="unit_price_display" class="form-control" readonly placeholder="选择后显示">
            </div>
            <div class="mb-3">
                <label class="form-label">时长（小时）*</label>
                <input type="number" name="duration_hours" id="duration_hours" class="form-control" step="0.5" min="0.5" max="24" value="1" required>
                <small class="text-muted">0.5～24 小时</small>
            </div>
            <div class="mb-3">
                <label class="form-label">预估总价</label>
                <input type="text" id="total_display" class="form-control" readonly placeholder="单价×时长">
            </div>
            <div class="mb-3">
                <label class="form-label">优惠券码</label>
                <input type="text" name="coupon_code" class="form-control" placeholder="可选">
            </div>
            <div class="mb-3">
                <label class="form-label">备注</label>
                <textarea name="description" class="form-control" rows="2" placeholder="如时间段、语音/文字等"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">提交订单</button>
            <a href="{{ url_for('customer_peiwan_index') }}" class="btn btn-outline-secondary">陪玩价格</a>
            <a href="{{ url_for('customer_index') }}" class="btn btn-outline-secondary">代肝价格</a>
        </form>
        {% endif %}
    </div>
</div>

<script>
var priceData = {{ price_data|tojson }};
var gameSelect = document.getElementById('game');
var taskSelect = document.getElementById('task_type');
var unitDisplay = document.getElementById('unit_price_display');
var durationInput = document.getElementById('duration_hours');
var totalDisplay = document.getElementById('total_display');
function updateTaskOptions(selectedGame) {
    if (!taskSelect) return;
    taskSelect.innerHTML = '<option value="">请选择陪玩类型</option>';
    if (unitDisplay) unitDisplay.value = '';
    if (totalDisplay) totalDisplay.value = '';
    if (selectedGame && priceData[selectedGame]) {
        priceData[selectedGame].forEach(function(t) {
            var opt = document.createElement('option');
            opt.value = t.task_type;
            opt.text = t.task_type + ' ￥' + t.price + (t.unit || '元/小时');
            opt.dataset.price = t.price;
            taskSelect.appendChild(opt);
        });
    }
}
function updateTotal() {
    var opt = taskSelect && taskSelect.options[taskSelect.selectedIndex];
    var unitPrice = opt && opt.dataset.price ? parseFloat(opt.dataset.price) : 0;
    var duration = durationInput ? parseFloat(durationInput.value) || 1 : 1;
    if (unitDisplay) unitDisplay.value = unitPrice ? '￥' + unitPrice + '/小时' : '';
    if (totalDisplay) totalDisplay.value = unitPrice ? '￥' + (Math.round(unitPrice * duration * 100) / 100) : '';
}
if (gameSelect) gameSelect.addEventListener('change', function() { updateTaskOptions(this.value); });
if (taskSelect) taskSelect.addEventListener('change', updateTotal);
if (durationInput) durationInput.addEventListener('input', updateTotal);
var g = new URLSearchParams(location.search).get('game');
var t = new URLSearchParams(location.search).get('task_type');
if (gameSelect && g) { gameSelect.value = g; updateTaskOptions(g); if (t && taskSelect) setTimeout(function() { taskSelect.value = t; updateTotal(); }, 50); }
</script>
{% endblock %}
