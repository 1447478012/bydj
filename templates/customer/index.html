{% extends "base.html" %}
{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span><i class="fas fa-tags"></i> æ¸¸æˆä»£ç»ƒä»·æ ¼è¡¨</span>
        <div class="d-flex gap-2 flex-wrap align-items-center">
            <form method="GET" class="d-flex gap-2 align-items-center" action="{{ url_for('customer_index') }}">
                <input type="text" name="phone" class="form-control" placeholder="è¾“å…¥æ‰‹æœºå·æŸ¥çœ‹ä¼šå‘˜ä»·" value="{{ phone or '' }}" style="width: 160px;">
                <button type="submit" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹ä¼šå‘˜ä»·</button>
            </form>
            <input type="text" id="searchTask" class="form-control" placeholder="ğŸ” æœç´¢ä»»åŠ¡ç±»å‹..." style="min-width: 200px;">
        </div>
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-3">
            <i class="fas fa-gem"></i> ä¼šå‘˜å¯äº«é¢å¤–æŠ˜æ‰£ï¼Œå¼€é€šä¼šå‘˜æ›´åˆ’ç®—ï¼
        </div>
        {% if price_table_images %}
        <div class="mb-4">
            <h5 class="mb-2"><i class="fas fa-image"></i> ä»·æ ¼è¡¨å‚è€ƒå›¾</h5>
            <div class="row g-2">
                {% for f in price_table_images %}
                <div class="col-md-4 col-6">
                    <a href="{{ url_for('serve_upload', filename='price_table/' + f) }}" target="_blank" class="d-block rounded overflow-hidden border">
                        <img src="{{ url_for('serve_upload', filename='price_table/' + f) }}" alt="ä»·æ ¼è¡¨" class="img-fluid" style="max-height:200px;object-fit:contain;width:100%;">
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% if customer and (membership or customer_level) %}
            <div class="alert alert-info mb-3 py-2">
                {% if membership %}
                    <i class="fas fa-gem"></i> å½“å‰å¥—é¤ï¼š<strong>{{ membership.plan.name }}</strong>ï¼Œäº«å— <strong>{{ (membership.plan.discount * 10)|int }} æŠ˜</strong>ï¼ˆå¼€é€šå³ç”Ÿæ•ˆï¼‰
                    {% if membership.end_date %} Â· æœ‰æ•ˆæœŸè‡³ {{ membership.end_date.strftime('%Y-%m-%d') }}{% endif %}
                {% else %}
                    <i class="fas fa-crown"></i> å½“å‰ä¼šå‘˜ç­‰çº§ï¼š<strong>{{ customer_level }}</strong>
                    {% if customer.total_spent %} | ç´¯è®¡æ¶ˆè´¹ï¼šï¿¥{{ "%.2f"|format(customer.total_spent) }}{% endif %}
                {% endif %}
            </div>
        {% elif phone %}
            <div class="alert alert-secondary mb-3 py-2">æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·å¯¹åº”çš„ä¼šå‘˜ä¿¡æ¯ï¼Œæ˜¾ç¤ºåŸä»·ã€‚</div>
        {% endif %}
        {% if grouped_prices %}
            {% for game, tasks in grouped_prices.items() %}
            <div class="game-section mb-4" data-game="{{ game }}">
                <h4 class="mb-3" style="color: #1565c0; border-bottom: 2px solid #90caf9; padding-bottom: 8px;">
                    <i class="fas fa-gamepad"></i> {{ game }}
                </h4>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡ç±»å‹</th>
                                <th>ä»·æ ¼</th>
                                <th>å•ä½</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr class="task-row" data-task="{{ task.task_type }}">
                                <td>{{ task.task_type }}</td>
                                <td>
                                    {% if (membership or customer_level) and task.member_price != task.price %}
                                        <span class="text-muted text-decoration-line-through">ï¿¥{{ task.price }}</span>
                                        <strong class="text-danger">ï¿¥{{ task.member_price }}</strong>
                                        <span class="badge bg-success ms-1">ä¼šå‘˜ä»·</span>
                                    {% else %}
                                        <strong>ï¿¥{{ task.price }}</strong>
                                    {% endif %}
                                </td>
                                <td>{{ task.unit or 'å…ƒ/æ¬¡' }}</td>
                                <td>{{ task.remark or '' }}</td>
                                <td>
                                    <a href="{{ url_for('customer_order') }}?game={{ task.game|urlencode }}&task_type={{ task.task_type|urlencode }}{% if phone %}&phone={{ phone|urlencode }}{% endif %}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-shopping-cart"></i> ç«‹å³ä¸‹å•
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-center">æš‚æ— ä»·æ ¼æ•°æ®ï¼Œè¯·ç¨åå†æ¥æˆ–è”ç³»å®¢æœã€‚</p>
        {% endif %}
    </div>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button id="backToTop" class="back-to-top" title="è¿”å›é¡¶éƒ¨">
    <i class="fas fa-arrow-up"></i>
</button>

<style>
    /* è¿”å›é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
    .back-to-top {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(100, 181, 246, 0.9);
        border: 2px solid #42a5f5;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        z-index: 1000;
        display: none; /* é»˜è®¤éšè— */
        align-items: center;
        justify-content: center;
    }
    .back-to-top:hover {
        background: #64b5f6;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(33, 150, 243, 0.6);
    }
</style>

<script>
    // å®æ—¶æœç´¢è¿‡æ»¤ä»»åŠ¡ç±»å‹
    document.getElementById('searchTask').addEventListener('input', function(e) {
        const keyword = e.target.value.toLowerCase().trim();
        const sections = document.querySelectorAll('.game-section');
        
        sections.forEach(section => {
            const rows = section.querySelectorAll('.task-row');
            let hasVisible = false;
            
            rows.forEach(row => {
                const task = row.dataset.task.toLowerCase();
                if (keyword === '' || task.includes(keyword)) {
                    row.style.display = '';
                    hasVisible = true;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // å¦‚æœè¯¥æ¸¸æˆä¸‹æ²¡æœ‰å¯è§è¡Œï¼Œéšè—æ•´ä¸ªæ¸¸æˆåŒºå—ï¼ˆå¯é€‰ï¼‰
            // section.style.display = hasVisible ? '' : 'none';
        });
    });

    // è¿”å›é¡¶éƒ¨æŒ‰é’®é€»è¾‘
    const backToTop = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            backToTop.style.display = 'flex';
        } else {
            backToTop.style.display = 'none';
        }
    });
    backToTop.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
</script>
{% endblock %}