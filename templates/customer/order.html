{% extends "base.html" %}
{% block content %}
<div class="card">
    <div class="card-header">
        <i class="fas fa-shopping-cart"></i> 提交代练订单
    </div>
    <div class="card-body">
        {% if current_customer %}
        <div class="alert alert-info py-2">您已登录，将以此账号（{{ current_customer.phone }}）创建订单。</div>
        {% endif %}
        <form method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label class="form-label">手机号 *</label>
                <input type="tel" name="phone" class="form-control" value="{{ current_customer.phone if current_customer else '' }}" {{ 'readonly' if current_customer else '' }} required>
            </div>
            <div class="mb-3">
                <label class="form-label">称呼</label>
                <input type="text" name="name" class="form-control" value="{{ current_customer.name if current_customer else '' }}" placeholder="选填">
            </div>
            <div class="mb-3">
                <label class="form-label">游戏 *</label>
                <select name="game" id="game" class="form-select" required>
                    <option value="">请选择</option>
                    {% for g in games %}
                    <option value="{{ g[0] }}">{{ g[0] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">任务类型 *</label>
                <select name="task_type" id="task_type" class="form-select" required>
                    <option value="">请先选择游戏</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">参考价格</label>
                <input type="text" id="price_display" class="form-control" readonly placeholder="选择后自动显示">
            </div>
            <div class="mb-3">
                <label class="form-label">积分抵扣（100积分=1元）</label>
                <input type="number" name="points_used" id="points_used" class="form-control" min="0" value="0" placeholder="输入使用的积分">
                <small class="text-muted">可用积分需在支付时验证，新用户默认为0</small>
            </div>
            <div class="mb-3">
                <label class="form-label">优惠券码</label>
                <input type="text" name="coupon_code" id="coupon_code" class="form-control" placeholder="输入优惠券码（可选）">
            </div>
            <div class="mb-3">
                <label class="form-label">需求描述 *</label>
                <textarea name="description" class="form-control" rows="5" required></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">截图/附件（可选）</label>
                <div class="drop-zone">
                    <span class="drop-zone-hint"><i class="fas fa-cloud-upload-alt"></i> 拖到此处或点击选择</span>
                    <input type="file" name="screenshot" class="form-control">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">提交订单</button>
            <a href="{{ url_for('customer_request_submit') }}" class="btn btn-outline-secondary">没有价格表？去提交需求</a>
            <a href="{{ url_for('customer_order_custom') }}" class="btn btn-outline-success">私人定制（年卡及以上）</a>
        </form>
    </div>
</div>

<script>
    // 价格数据从后端传递
    var priceData = {{ price_data|safe }};
    var gameSelect = document.getElementById('game');
    var taskSelect = document.getElementById('task_type');
    var priceDisplay = document.getElementById('price_display');

    // 获取URL参数函数
    function getUrlParameter(name) {
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // 更新任务类型下拉框
    function updateTaskOptions(selectedGame) {
        taskSelect.innerHTML = '<option value="">请选择任务类型</option>';
        priceDisplay.value = '';
        if (selectedGame && priceData[selectedGame]) {
            var tasks = priceData[selectedGame];
            for (var i = 0; i < tasks.length; i++) {
                var option = document.createElement('option');
                option.value = tasks[i].task_type;
                option.text = tasks[i].task_type;
                option.dataset.price = tasks[i].price;
                taskSelect.appendChild(option);
            }
        }
    }

    // 游戏选择变化事件
    gameSelect.addEventListener('change', function() {
        updateTaskOptions(this.value);
    });

    // 任务类型选择变化事件
    taskSelect.addEventListener('change', function() {
        var selectedOption = this.options[this.selectedIndex];
        if (selectedOption && selectedOption.dataset.price) {
            priceDisplay.value = '￥' + selectedOption.dataset.price;
        } else {
            priceDisplay.value = '';
        }
    });

    // 从URL参数自动填充
    (function autoFillFromUrl() {
        var urlGame = getUrlParameter('game');
        var urlTask = getUrlParameter('task_type');

        if (urlGame) {
            // 设置游戏下拉框的值
            gameSelect.value = urlGame;
            // 更新任务类型选项
            updateTaskOptions(urlGame);
            
            // 如果URL中有任务类型，且任务类型下拉框有对应选项，则选中它
            if (urlTask) {
                // 短暂延迟以确保选项已添加
                setTimeout(function() {
                    taskSelect.value = urlTask;
                    // 触发change事件更新价格
                    var event = new Event('change');
                    taskSelect.dispatchEvent(event);
                }, 50);
            }
        }
    })();
</script>
{% endblock %}