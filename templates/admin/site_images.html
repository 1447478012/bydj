{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 style="color: #b34b6b;"><i class="fas fa-images"></i> 站点图片设置</h2>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">返回面板</a>
</div>
<p class="text-muted">上传或替换以下图片后，前台会自动识别新图（带版本号，避免缓存）。未上传时使用 <code>static/images/</code> 下的默认图。</p>

<!-- 背景轮播图（图床）：多图上传，前台轮播 -->
<div class="card mb-4">
    <div class="card-header"><i class="fas fa-layer-group"></i> 背景轮播图（图床）</div>
    <div class="card-body">
        <p class="text-muted small mb-3">上传多张图片后，前台背景将按上传顺序轮播。若此处未上传任何图，则使用下方「背景轮播图1/2/3」。</p>
        {% if background_slides %}
        <div class="mb-3">
            <strong>已上传（{{ background_slides | length }} 张，按顺序轮播）：</strong>
            <div class="d-flex flex-wrap gap-3 mt-2">
                {% for item in background_slides %}
                <div class="border rounded p-2 bg-light" style="max-width: 160px;">
                    <img src="{{ item.url }}" alt="" class="img-fluid rounded" style="height:80px;object-fit:cover;width:100%;">
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted text-truncate" style="max-width:100px;">{{ item.filename }}</small>
                        <form method="POST" class="d-inline" onsubmit="return confirm('确定删除这张背景图？');">
                            <input type="hidden" name="delete_bg" value="{{ item.filename }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <p class="text-muted mb-3">暂无上传，请添加图片；或使用下方「背景轮播图1/2/3」。</p>
        {% endif %}
        <div id="bgDropZone" class="bg-drop-zone mb-3">
            <input type="file" id="bgDropInput" name="bg_upload" accept="image/*" multiple style="display:none;">
            <p class="mb-1"><i class="fas fa-cloud-upload-alt fa-2x text-secondary"></i></p>
            <p class="mb-0 text-muted">将图片拖到此处，或 <a href="#" class="bg-drop-link">点击选择</a></p>
        </div>
        <form method="POST" enctype="multipart/form-data" id="bgUploadForm" class="d-flex align-items-end gap-2 flex-wrap">
            <div class="mb-0">
                <label class="form-label small">追加一张背景图</label>
                <input type="file" name="bg_upload" class="form-control form-control-sm" accept="image/*" style="max-width: 260px;">
            </div>
            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> 添加</button>
        </form>
    </div>
</div>

<style>
.bg-drop-zone {
    border: 2px dashed #adb5bd;
    border-radius: 12px;
    padding: 28px 20px;
    text-align: center;
    background: rgba(0,0,0,0.02);
    transition: border-color .2s, background .2s;
}
.bg-drop-zone.drag-over {
    border-color: #0d6efd;
    background: rgba(13, 110, 253, 0.08);
}
.bg-drop-zone .bg-drop-link { cursor: pointer; }
</style>
<script>
(function() {
    var zone = document.getElementById('bgDropZone');
    var input = document.getElementById('bgDropInput');
    if (!zone || !input) return;
    var formAction = document.querySelector('#bgUploadForm') ? document.querySelector('#bgUploadForm').action : window.location.href;

    zone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        zone.classList.add('drag-over');
    });
    zone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        zone.classList.remove('drag-over');
    });
    zone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        zone.classList.remove('drag-over');
        var files = e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files : [];
        if (!files.length) return;
        var imageTypes = ['image/jpeg','image/png','image/gif','image/webp'];
        var toUpload = [];
        for (var i = 0; i < files.length; i++) {
            if (imageTypes.indexOf(files[i].type) !== -1) toUpload.push(files[i]);
        }
        if (!toUpload.length) { alert('请拖入图片文件（jpg/png/gif/webp）'); return; }
        var idx = 0;
        function doNext() {
            if (idx >= toUpload.length) { window.location.reload(); return; }
            var fd = new FormData();
            fd.append('bg_upload', toUpload[idx]);
            fetch(formAction, { method: 'POST', body: fd, redirect: 'manual' })
                .then(function() { idx++; doNext(); })
                .catch(function() { idx++; doNext(); });
        }
        doNext();
    });

    zone.querySelector('.bg-drop-link') && zone.querySelector('.bg-drop-link').addEventListener('click', function(e) {
        e.preventDefault();
        input.click();
    });
    input.addEventListener('change', function() {
        if (!input.files || !input.files.length) return;
        var files = input.files;
        var imageTypes = ['image/jpeg','image/png','image/gif','image/webp'];
        var toUpload = [];
        for (var i = 0; i < files.length; i++) {
            if (imageTypes.indexOf(files[i].type) !== -1) toUpload.push(files[i]);
        }
        if (!toUpload.length) { alert('请选择图片文件（jpg/png/gif/webp）'); input.value = ''; return; }
        var idx = 0;
        function doNext() {
            if (idx >= toUpload.length) { input.value = ''; window.location.reload(); return; }
            var fd = new FormData();
            fd.append('bg_upload', toUpload[idx]);
            fetch(formAction, { method: 'POST', body: fd, redirect: 'manual' })
                .then(function() { idx++; doNext(); })
                .catch(function() { idx++; doNext(); });
        }
        doNext();
    });
})();
</script>

<p class="text-muted small mb-2">
    <strong>文件夹识别：</strong>将微信支付码图片放入 <code>uploads/wechat/</code>、支付宝支付码放入 <code>uploads/alipay/</code>，系统会自动识别该文件夹内最新一张图（无需在本页上传）。本页上传的图优先于文件夹。
</p>
<div class="card">
    <div class="card-header"><i class="fas fa-upload"></i> 上传/替换图片</div>
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            {% for key, label in site_image_keys.items() %}
            {% set finfo = image_info.get(key) %}
            <div class="row align-items-center mb-4 border-bottom pb-4">
                <div class="col-md-2">
                    <label class="form-label fw-bold">{{ label }}</label>
                    <small class="d-block text-muted">({{ key }})</small>
                </div>
                <div class="col-md-4">
                    {% if finfo and finfo[0] %}
                    <img src="{{ site_image_url(key) }}" alt="{{ label }}" class="img-fluid rounded border" style="max-height:120px;object-fit:contain;">
                    <small class="text-success">已设置 · 重新上传即替换</small>
                    {% else %}
                    <span class="text-muted">未上传，使用默认图</span>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <div class="drop-zone">
                        <span class="drop-zone-hint"><i class="fas fa-cloud-upload-alt"></i> 拖到此处或点击</span>
                        <input type="file" name="{{ key }}" class="form-control" accept="image/*">
                    </div>
                </div>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存并更新</button>
        </form>
    </div>
</div>
<p class="mt-3 text-muted small">
    <i class="fas fa-info-circle"></i> 支持 jpg、png、gif、webp。替换后刷新前台页面即可看到新图；若仍显示旧图，可强制刷新（Ctrl+F5）或清除浏览器缓存。
</p>
{% endblock %}
